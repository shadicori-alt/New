{% extends "base.html" %}

{% block title %}Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fab fa-whatsapp text-green-600 ml-2"></i>
            Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ÙŠØ²Ù†Ø³
        </h1>
        <p class="text-gray-600">Ø¥Ø¯Ø§Ø±Ø© Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ÙŠØ²Ù†Ø³</p>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ÙŠØ²Ù†Ø³</h2>
        
        <div id="connection-status" class="mb-4">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <div id="status-icon" class="w-3 h-3 bg-red-500 rounded-full ml-3"></div>
                    <span id="status-text" class="font-medium text-gray-700">ØºÙŠØ± Ù…ØªØµÙ„</span>
                </div>
                <button onclick="testConnection()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    <i class="fas fa-plug ml-2"></i>
                    Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                </button>
            </div>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="text" id="phone-number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="9665XXXXXXXX">
                <p class="text-sm text-gray-500 mt-1">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯ (966 Ù„Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©)</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Access Token</label>
                <input type="password" id="access-token" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ø£Ø¯Ø®Ù„ Access Token">
                <p class="text-sm text-gray-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ù† Meta for Developers</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨ (Account ID)</label>
                <input type="text" id="account-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ø£Ø¯Ø®Ù„ Account ID">
                <p class="text-sm text-gray-500 mt-1">Ù…Ø¹Ø±Ù Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ÙŠØ²Ù†Ø³ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
            </div>
            
            <button onclick="connectWhatsApp()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium">
                <i class="fab fa-whatsapp ml-2"></i>
                Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ÙŠØ²Ù†Ø³
            </button>
        </div>
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                <div>
                    <h3 class="font-medium text-gray-800">Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
                    <p class="text-sm text-gray-600">ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-reply-toggle" onchange="toggleAutoReply()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                <div>
                    <h3 class="font-medium text-gray-800">Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©</h3>
                    <p class="text-sm text-gray-600">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="welcome-message-toggle" onchange="toggleWelcomeMessage()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg">
                <div>
                    <h3 class="font-medium text-gray-800">ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                    <p class="text-sm text-gray-600">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="order-confirmation-toggle" onchange="toggleOrderConfirmation()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                <textarea id="welcome-message" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©...">Ù…Ø±Ø­Ø¨Ø§Ù‹ {name}! ğŸ‘‹

Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ

Ù„Ù„Ø·Ù„Ø¨:
ğŸ“± Ø±Ø§Ø³Ù„Ù†Ø§ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬
ğŸ“ Ø£Ø±Ø³Ù„ Ø¹Ù†ÙˆØ§Ù†Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„
ğŸ“ ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ

Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± 24/7 ğŸ•"></textarea>
                <p class="text-sm text-gray-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: {name} - {page_name}</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <div class="space-y-2">
                    <input type="text" id="button-1" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ù†Øµ Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙˆÙ„">
                    <input type="url" id="button-1-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙˆÙ„">
                    
                    <input type="text" id="button-2" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ù†Øµ Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
                    <input type="url" id="button-2-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
                    
                    <input type="text" id="button-3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ù†Øµ Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù„Ø«">
                    <input type="url" id="button-3-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù„Ø«">
                </div>
                <p class="text-sm text-gray-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø­ØªÙ‰ 3 Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©</p>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="saveWelcomeMessage()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                    <i class="fas fa-save ml-2"></i>
                    Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                </button>
                <button onclick="testWelcomeMessage()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-paper-plane ml-2"></i>
                    Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isConnected = false;

function connectWhatsApp() {
    const phoneNumber = document.getElementById('phone-number').value;
    const accessToken = document.getElementById('access-token').value;
    const accountId = document.getElementById('account-id').value;
    
    if (!phoneNumber || !accessToken || !accountId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
    const phoneRegex = /^9665[0-9]{8}$/;
    if (!phoneRegex.test(phoneNumber)) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø³Ø¹ÙˆØ¯ÙŠ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: 966512345678)');
        return;
    }
    
    fetch('/admin/whatsapp/connect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            phone_number: phoneNumber,
            access_token: accessToken,
            account_id: accountId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateConnectionStatus(true);
            alert('ØªÙ… Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ÙŠØ²Ù†Ø³ Ø¨Ù†Ø¬Ø§Ø­!');
        } else {
            alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + data.message);
        }
    });
}

function testConnection() {
    fetch('/admin/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            service: 'whatsapp'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateConnectionStatus(true);
        } else {
            updateConnectionStatus(false);
        }
        
        alert(data.message);
    });
}

function updateConnectionStatus(connected) {
    isConnected = connected;
    const statusIcon = document.getElementById('status-icon');
    const statusText = document.getElementById('status-text');
    
    if (connected) {
        statusIcon.className = 'w-3 h-3 bg-green-500 rounded-full ml-3';
        statusText.textContent = 'Ù…ØªØµÙ„';
        statusText.className = 'font-medium text-green-700';
    } else {
        statusIcon.className = 'w-3 h-3 bg-red-500 rounded-full ml-3';
        statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
        statusText.className = 'font-medium text-red-700';
    }
}

function toggleAutoReply() {
    const enabled = document.getElementById('auto-reply-toggle').checked;
    console.log('Auto reply:', enabled);
}

function toggleWelcomeMessage() {
    const enabled = document.getElementById('welcome-message-toggle').checked;
    console.log('Welcome message:', enabled);
}

function toggleOrderConfirmation() {
    const enabled = document.getElementById('order-confirmation-toggle').checked;
    console.log('Order confirmation:', enabled);
}

function saveWelcomeMessage() {
    const message = document.getElementById('welcome-message').value;
    const buttons = [];
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    for (let i = 1; i <= 3; i++) {
        const buttonText = document.getElementById('button-' + i).value;
        const buttonUrl = document.getElementById('button-' + i + '-url').value;
        
        if (buttonText && buttonUrl) {
            buttons.push({
                text: buttonText,
                url: buttonUrl
            });
        }
    }
    
    fetch('/admin/whatsapp/welcome-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            buttons: buttons
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
        }
    });
}

function testWelcomeMessage() {
    const phoneNumber = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©:');
    
    if (phoneNumber) {
        fetch('/admin/whatsapp/test-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone_number: phoneNumber,
                type: 'welcome'
            })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
        });
    }
}

// Ø´Ø±Ø­ Ø§Ù„ØµÙØ­Ø©
function explainPage() {
    const input = document.getElementById('chatInput');
    input.value = 'Ø§Ø´Ø±Ø­ Ù„ÙŠ ÙˆØ¸Ø§Ø¦Ù ØµÙØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø¨ÙŠØ²Ù†Ø³ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©';
    sendMessage();
}
</script>
{% endblock %}